{% extends 'fibeWWWConfBundle::base.html.twig' %}

{% block title %}Index{% endblock title %}
{% block body %}
{{ parent() }}
 

{% trans_default_domain 'FOSUserBundle' %}
<div class="container">
  <div class="row center">
    <header class="subhead" id="overview">
        <div class="page-header">
            <h1>Manage user</h1>
        </div>
    </header>
    <table class="records_list table table-striped table-hover">
        <thead>
            <tr>
                <th>User</th>
                <th>Email</th>
                <th>Last login</th>
                <th>Role</th> 
                <th>DataConf Authorization</th>
                <th>Schedule Authorization</th>
                <th>Datas Conference Authorization</th> 
            </tr>
        </thead>
        <tbody>
        {% for entity in entities %}
            <tr>
                <td>
                    <div class="btn-group">
                        <button class="btn dropdown-toggle" data-toggle="dropdown">
                            <b>{{ entity.username }}</b>
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="{{ path('schedule_user_toggle_role', { 'id': entity.id }) }}"> 
                                        {% if  'ROLE_ADMIN' in entity.roles %}
                                              demote to manager 
                                        {% else %}
                                             promote to admin 
                                        {% endif %} 
                                </a>  
                            </li>
                            <li>
                                <a href="#" onclick="document.getElementById('delete-form{{ loop.index0 }}').submit()"><i class=" icon-trash"></i> delete user</a>
                                
                            </li>

                        </ul>
                    </div>
                    <form style="height:0px;" id="delete-form{{ loop.index0 }}" action="{{ path('user_delete', { 'id': entity.id }) }}" method="post">
                        <input type="hidden" name="_method" value="DELETE" />
                        {{ form_widget(delete_forms[loop.index0]) }}
                    </form>
                </td>
                <td><a href="mailto:{{ entity.email }}">{{ entity.email }}</a></td>
                <td class="moment">{% if entity.lastLogin %}{{ entity.lastLogin|date('Y-m-d H:i:s') }}{% endif %}</td> 
                <td>
                    <div class="btn-group">
                        <button class="btn dropdown-toggle" data-toggle="dropdown">
                            {% if  'ROLE_ADMIN' in entity.roles %}
                                Admin
                            {% else %}
                                Manager
                            {% endif %} 
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="{{ path('schedule_user_toggle_role', { 'id': entity.id }) }}"> 
                                        {% if  'ROLE_ADMIN' in entity.roles %}
                                              demote to manager 
                                        {% else %}
                                             promote to admin 
                                        {% endif %} 
                                </a> 
                                     
                            </li>
                        </ul>
                    </div>
                    <form style="height:0px;" id="toggle-role-form{{ loop.index0 }}" action="{{ path('user_delete', { 'id': entity.id }) }}" method="post">
                        <input type="hidden" name="_method" value="DELETE" />
                        {{ form_widget(delete_forms[loop.index0]) }}
                    </form>
                    
                </td> 
                <td>
                  <select class="flagAppWR" data-userId="{{entity.id }}">
                    {% if  entity.getFlagAppByConferenceId(currentConf.id) == 1 %}
                        <option value="1" selected>Read/Write</option>
                        <option value="0">Read</option>
                    {% else %}
                         <option value="1">Read/Write</option>
                         <option value="0" selected>Read</option>
                    {% endif %} 
                   </select>
                 </td> 
                 <td>
                  <select class="flagSchedWR" data-userId="{{entity.id }}">
                    {% if  entity.getFlagSchedByConferenceId(currentConf.id) == 1 %}
                        <option value="1" selected>Read/Write</option>
                        <option value="0">Read</option>
                    {% else %}
                         <option value="1">Read/Write</option>
                         <option value="0" selected>Read</option>
                    {% endif %} 
                   </select>
                 </td>  
                 <td>
                  <select class="flagconfDatasWR" data-userId="{{entity.id }}">
                    {% if  entity.getFlagDatasByConferenceId(currentConf.id) == 1 %}
                        <option value="1" selected>Read/Write</option>
                        <option value="0">Read</option>
                    {% else %}
                         <option value="1">Read/Write</option>
                         <option value="0" selected>Read</option>
                    {% endif %} 
                   </select>
                 </td>  
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <!--<a class="btn btn-info" href="{{ path('fos_user_registration_register') }}">
        <i class="icon-plus icon-white"> </i> Add user in conference
    </a>-->
    <a class="btn btn-info" id="addUserInConference" onclick="$('#addUserInConferenceForm').toggle('slow')">
        <i class="icon-plus icon-white"></i> Add user in conference
    </a>
    <div id="addUserInConferenceForm">
          <form action="{{ path('schedule_user_create_authorization') }}" method="post" {{ form_enctype(authorization_form) }}>
            <table class="records_list table table-striped table-hover">
                <tr>
                    <th>Manager</th>
                    <th>DataConf Authorization</th>
                    <th>Schedule Authorization</th>
                    <th>Datas Conference Authorization</th> 
                </tr>
                    <td>
                      {{ form_row(authorization_form.user) }}
                    </td>
                    <td>
                      {{ form_row(authorization_form.flagAppWR) }}
                    </td> 
                    <td>
                       {{ form_row(authorization_form.flagSchedWR) }}
                    </td>  
                    <td>
                       {{ form_row(authorization_form.flagconfDatasWR) }}
                    </td>
               </tr>  
            </table>
            <button type="submit" class="btn btn-block btn-success">
                          <i class="icon-ok"></i>
            </button>
        </form>
        
    <div>
  </div>
<div>
{% endblock body %}

{%  block javascripts %}
{{ parent() }}
    <script src="{{ asset('bundles/fibewwwconf/js/moment.min.js') }}" type="text/javascript" ></script>
    <script  type="text/javascript" >

    //Add User in conference action
    $("#addUserInConference").click(function(){


    })
     function changeAuthorization(id,authorizationType,value){
        console.log(id);
        //start send the post request           
           $.ajax({
              type: "POST",
              url: "{{path('schedule_user_change_authorization')}}",
              data: { 'value' : value , 'authorizationType': authorizationType,'id':id},
            });
      };

        $(document).ready(function(){
            //Hide add manager form
            $("#addUserInConferenceForm").hide();
            $('.moment').each(function(){
                var momentString = moment($(this).html()); 
                !momentString || $(this).html(momentString.format("dddd, MMMM Do YYYY, h:mm:ss a"));
            })

            //Listen change authorization select
            $(".flagAppWR").change(function(){
                value = $(this).val();
                id = $(this).attr("data-userId");
                changeAuthorization(id,'app',value);
            })
            $(".flagSchedWR").change(function(){
                value = $(this).val();
                id = $("#flagSchedWR").attr("data-userId");
                changeAuthorization(id,'sched',value);
            })
            $(".flagconfDatasWR").change(function(){
                value = $(this).val();
                id = $(this).attr("data-userId");
                changeAuthorization(id,'datas',value);
            })

        });

       
    </script>

{% endblock %}

 