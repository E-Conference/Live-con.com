{% extends "fibeWWWConfBundle::base.html.twig" %}


{% block title %}Schedule{% endblock title %}




{% block body %}
{{ parent() }} 
  
      

    <div id='calendar'></div> 
     <div id="sidebar">  
        <h4>Draggable Events</h4>
        <div id='external-events'>
        </div>
     </div> 
 
<div id="modal" class="modal hide fade">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Edit event</h3>
  </div>
  <div class="modal-body">
    <p>One fine bodyâ€¦</p>
  </div> 
</div>
 


{% endblock %}



 {% block stylesheets %}
 
    <!--
    <link rel='stylesheet' type='text/css' href='http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/start/jquery-ui.css' />
    -->
<link rel="stylesheet" type="text/css" href="{{ asset('bootstrap/css/bootstrap-responsive.css') }}" />

<link href="{{ asset('bundles/fibewwwconf/js/fullcalendar/fullcalendar.css') }}" rel='stylesheet' />
<link href="{{ asset('bundles/fibewwwconf/js/fullcalendar/fullcalendar.print.css') }}" rel='stylesheet' media='print' />
    <style type="text/css">
        
  
    #calendar {
        position: relative; 
        margin-top: 40px; 
        width: 80%;
        margin-left: 2%
    }
        
    #sidebar {
        /*position: fixed;*/
        position: absolute;
        right: 0; 
        top: 0;
        margin-top: 41px;
        padding: 1em 0.5em;
        /*height: 100%; */
        width: 15%;
        padding: 0 10px; 
        background: #eee;
        z-index: 1;
    }
        
    #sidebar h4 {
        font-size: 16px;
        margin-top: 0;
        padding-top: 1em;
    }

    #external-events{
        border: 1px solid #ccc;
        padding: 1em 0.5em;
        margin: 0;
        position: relative; 
        z-index: 2; 
        /*overflow:    auto;
        height: calc(100% - 50px);*/ /*sidebar h4 height*/

    }
        
    .external-event { /* try to mimick the look of a real event */
        margin-bottom: 1em;
        padding: 2px 4px;
        background: #3366CC;
        color: #fff;
        font-size: .85em;
        cursor: pointer;
    }
        
    #sidebar p {
        margin: 1.5em 0;
        font-size: 11px;
        color: #666;
    }
        
    #sidebar p input {
        margin: 0;
        vertical-align: middle;
    }

    #modal{
        width: 96%;
        left: 2%; 
        margin: 0;
    }

    #bootstrap_alert{
        position: fixed;
        top: 5em;
        right: 2em ;
        min-width: 20em;
        z-index: 1000; 

    }


    </style>

{% endblock stylesheets %}



{%  block javascripts %}    
<script src="{{ asset('bundles/fibewwwconf/js/moment.min.js') }}" type="text/javascript" ></script>
     
<script src="{{ asset('bundles/fibewwwconf/js/fullcalendar/jquery-ui-1.10.3.custom.min.js') }}"></script>
<script src="{{ asset('bundles/fibewwwconf/js/fullcalendar/fullcalendar.js') }}"></script>

    
    <script type="text/javascript">
        $(document).ready(function() {    
 
            //event edit popup
            $modal = $('#modal').hide();
            $modalBody = $modal.find(".modal-body");

           // calcule du premier jour
            var firstDay = moment('5000-10-10');
            {% for events in currentConf.confEvents %}
                {% if date(events.startAt) > date("1980-01-02") %}
                    
                    if(moment('{{events.startAt|date("Y-m-d")}}').isBefore(firstDay)){
                        firstDay = moment('{{events.startAt|date("Y-m-d")}}');
                    }

                {% endif %}
            {% endfor %}  
            
            var DATA_FEED_URL = "{{ path('wwwconf_getevents') }}";
            //alert(DATA_FEED_URL);    
            var op = { 
                showday       : new Date({% if currentConf %}firstDay.format(){% else %}{% endif %}), 
                url           : DATA_FEED_URL + "?method=list",  
                quickAddUrl   : DATA_FEED_URL + "?method=add", 
                quickUpdateUrl: DATA_FEED_URL + "?method=update",
                updateUrl     : "{{ path('wwwconf_editEvent') }}",
                quickDeleteUrl: DATA_FEED_URL + "?method=remove", 
            };


 
        /* initialize the calendar
        -----------------------------------------------------------------*/
        var $calendar = $('#calendar');
        $calendar.fullCalendar({ 
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            }, 
            editable: true,
            //fist day
            year: firstDay.year(), 
            month: firstDay.month(),
            date: firstDay.date(),
            //get events
            events: function(start, end, callback) { 
                $.ajax({
                    url: op.url,
                    dataType: 'json',  
                    success: function(doc) {  
                        if(callback)callback(doc.events);
                        setInstantEvents(doc.instant_events);
                    }
                });
            },  
            eventClick: function(calEvent, jsEvent, view) {
 
                $('.fc-event').click(function(){
                    $.ajax({
                        url: op.updateUrl+"?id="+calEvent.id,  
                        success: function(doc) {  
                            $modal.modal("show");
                            $modalBody.html(doc);
                        }
                    });
                    bootstrapAlert("info","edit request sent <i class='icon-spinner icon-spin icon-large'></i>","Info");
                }); 

            },
            selectable: true, 
            selectHelper: true,
            select: function(start, end, allDay) {
                var title = prompt('Event Title:');
                if (title) {
                    var e = {
                        title: title,
                        start: start,
                        end: end,
                        allDay: allDay
                    };
                    $.post(
                            op.quickAddUrl,
                            formatDate(e),
                            function(response) {  
                                bootstrapAlert("success","event has been well added","Success");
                                e.id=response.id;
                                $calendar.fullCalendar('renderEvent',e  ); // 3rd arg make the event "stick" 
                            },
                            'json'
                    );
                    bootstrapAlert("info","add request sent <i class='icon-spinner icon-spin icon-large'></i>","Info");
                }
                $calendar.fullCalendar('unselect');
            },
            eventResize: function(event,dayDelta,minuteDelta,revertFunc) {

                    $.post(
                            op.quickUpdateUrl,
                            formatDate($.extend({}, event)),
                            function(doc) {  
                                bootstrapAlert("success","event has been well updated","Success"); 
                            },
                            'json'
                    );
                    bootstrapAlert("info","update request sent <i class='icon-spinner icon-spin icon-large'></i>","Info");

            },
            eventDataTransform: function(data){return data;},
            editable: true,
            droppable: true, // this allows things to be dropped onto the calendar !!!
            eventDrop : function(e){ 
                    $.post(
                            op.quickUpdateUrl,
                            formatDate($.extend({}, e)),
                            function(doc) {  
                                bootstrapAlert("success","event has been well updated","Success"); 
                            },
                            'json'
                    );
                    bootstrapAlert("info","update request sent <i class='icon-spinner icon-spin icon-large'></i>","Info");
            },
            drop: function(date, allDay) { // this function is called when something is dropped
            
                // retrieve the dropped element's stored Event Object
                var originalEventObject = $(this).data('eventObject');
                
                // we need to copy it, so that multiple events don't have a reference to the same object
                var copiedEventObject = $.extend({}, originalEventObject);
                
                // assign it the date that was reported 
                copiedEventObject.start  = date;
                copiedEventObject.end    = moment(date).add("hours",1);
                copiedEventObject.allDay = allDay; 
 
                $.post(
                        op.quickUpdateUrl,
                        formatDate(copiedEventObject),
                        function(doc) {   
                                bootstrapAlert("success","event has been well updated","Success"); 
                        },
                        'json'
                );
                bootstrapAlert("info","update request sent <i class='icon-spinner icon-spin icon-large'></i>","Info");
                // render the event on the calendar
                // the last `true` argument determines if the event "sticks" (http://arshaw.com/fullcalendar/docs/event_rendering/renderEvent/)
                $calendar.fullCalendar('renderEvent', copiedEventObject);
                
                $(this).remove(); 
                //console.log(copiedEventObject);
                
                
            }
        }); 
        $calendar.fullCalendar('changeView', "agendaWeek" )

            
        });

    var bootstrapAlertTimeout;
    function bootstrapAlert(c,msg,title){
        var $body = $("body");
        var $bootstrapAlert = $('#bootstrap_alert').length < 1 ? $('<div id="bootstrap_alert"></div>').prependTo($body) : $('#bootstrap_alert');
        $bootstrapAlert.attr("class","")
                       .addClass("alert alert-"+c) 
                       .html('<button type="button" class="close" data-dismiss="alert">&times;</button> <strong> '+title+' </strong>' +msg);
        if(!$bootstrapAlert.is(":visible"))$bootstrapAlert.hide().fadeIn();
        clearInterval(bootstrapAlertTimeout);
        bootstrapAlertTimeout=setInterval(function(){
                 $bootstrapAlert.fadeOut(1500);
            },5000);
    }


    function setInstantEvents(instant_events){
        var ctn = $('#external-events').html("");

        var event =  "<div class='external-event'></div>";
        for (var i in instant_events){
            var current_event = instant_events[i];
            console.log(current_event); 

            var $event = $(event).appendTo(ctn)
                                 .html(current_event['title'])
                                 .css({
                                    "background-color": current_event.color,
                                    "border-color": current_event.border_color || current_event.color,
                                 });  

            // store the Event Object in the DOM element so we can get to it later
            $event.data('eventObject', current_event);
            
            // make the event draggable using jQuery UI
            $event.draggable({
                start: function(event, ui) { 
                    $(this).css("z-index", 10);  
            }, 
                zIndex        : 20,
                revert        : true,      // will cause the event to go back to its
                revertDuration: 0  //  original position after the drag
            });
        }
    }

     function formatDate(e){
        e.start = moment(e.start).format();
        e.end = moment(e.end).format();
        return e;
     } 
    </script>    
	
{% endblock javascripts %}

